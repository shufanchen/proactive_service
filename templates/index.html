<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½ä¸»åŠ¨æœåŠ¡æ¨èç³»ç»Ÿ</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #f5f7fa; }
        .sidebar { height: 92vh; overflow-y: auto; }
        .result-card { margin-bottom: 12px; padding: 12px; border-radius: 8px; }
        .good { background-color: #d4edda; border-left: 6px solid #28a745; }
        .bad { background-color: #f8d7da; border-left: 6px solid #dc3545; }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            background: white;
        }
        .product-card:hover {
            box-shadow: 0px 0px 6px rgba(0,0,0,0.12);
        }
        .scroll-box {
    max-height: 350px;
    overflow-y: auto;
    padding-right: 5px;
}
        .scroll-box-large {
    max-height: 450px;
    overflow-y: auto;
    padding-right: 5px;
}
        .copy-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin-top: 8px;
            border-radius: 6px;
        }
        .loading-dot {
            animation: blink 1.4s infinite both;
        }
        @keyframes blink {
            0% { opacity: .2; }
            20% { opacity: 1; }
            100% { opacity: .2; }
        }
    </style>
</head>

<body>

<!-- é¡¶éƒ¨å¯¼èˆª -->
<nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">ğŸ“¦ äº¬ä¸œä¸»ç«™ä¸»åŠ¨æœåŠ¡æ™ºèƒ½æ¨è Â· å¯è§†åŒ– DEMO</span>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">

        <!-- å·¦æ ï¼šç”¨æˆ·é€‰æ‹© + ç”»åƒ -->
        <div class="col-3 sidebar">
            <h4 class="mb-3">ğŸ‘¤ ç”¨æˆ·é€‰æ‹©</h4>

            <div class="card mb-3">
                <div class="card-body">
                    <label class="form-label">è¯·é€‰æ‹©ç”¨æˆ·ï¼š</label>
                    <select id="userSelect" class="form-select" onchange="loadUserProfile()">
                        {% for u in users %}
                            <option value="{{u.user_id}}">{{u.user_id}} - {{u.user_type}}</option>
                        {% endfor %}
                    </select>

                    <button class="btn btn-success w-100 mt-3" onclick="startFiltering()">âš¡ å¼€å§‹å®æ—¶è¿‡æ»¤</button>
                </div>
            </div>

            <h5>ç”¨æˆ·ç”»åƒ</h5>
            <div id="userProfile" class="text-muted mb-3">
                è¯·é€‰æ‹©ç”¨æˆ·æŸ¥çœ‹ç”»åƒ...
            </div>
        </div>





        <!-- ä¸­æ ï¼šå•†å“æ±  + æµå¼è¿‡æ»¤ -->
        <div class="col-5">

            <!-- å•†å“æ± å±•ç¤ºï¼ˆåŠ å…¥æ»‘çª—ï¼‰ -->
            <div class="card mb-3 p-2">
                <h5>ğŸ“¦ å•†å“æ± ï¼ˆå¾…è¿‡æ»¤ï¼‰</h5>
                <div class="scroll-box">
                    <div class="row">
                        {% for p in products %}
                            <div class="col-6 mb-2">
                                <div class="border rounded p-2 bg-white">
                                    <b>{{p.name}}</b><br>
                                    <small>{{p.category}} | Â¥{{p.price}}</small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- å®æ—¶è¿‡æ»¤ç»“æœï¼ˆåŠ å…¥æ»‘çª—ï¼‰ -->
            <h4>ğŸ” å•†å“å®æ—¶è¿‡æ»¤</h4>
            <div class="progress mb-2" style="height: 20px;">
                <div id="progressBar" class="progress-bar" role="progressbar"
                     style="width: 0%">0%</div>
            </div>

            <div class="scroll-box-large" id="filterStreamArea">
                <p class="text-muted">ç‚¹å‡»å·¦ä¾§æŒ‰é’®å¼€å§‹å®æ—¶è¿‡æ»¤ã€‚</p>
            </div>

        </div>





        <!-- å³æ ï¼šå¯æ¨èå•†å“ï¼ˆå¡ç‰‡å½¢å¼ï¼‰ -->
        <div class="col-4 sidebar">
            <h4>ğŸ’š å¯æ¨èå•†å“</h4>
            <div id="recommendArea">
                <p class="text-muted">è¿‡æ»¤åè‡ªåŠ¨å‡ºç°åœ¨è¿™é‡Œã€‚</p>
            </div>
        </div>

    </div>
</div>


<!-- JS -->
<script>
let totalProducts = {{ products | length }};
let finishedCount = 0;


// =====================
// â‘  ç”¨æˆ·ç”»åƒåŠ è½½
// =====================
function loadUserProfile() {
    let userId = document.getElementById("userSelect").value;

    fetch("/get_user_profile?user_id=" + userId)
    .then(r => r.json())
    .then(user => {
        document.getElementById("userProfile").innerHTML = `
            <div class="card p-2">
                <b>ID:</b> ${user.user_id}<br>
                <b>ç±»å‹:</b> ${user.user_type}<br>
                <b>å¹´é¾„:</b> ${user.age}<br>
                <b>æ€§åˆ«:</b> ${user.gender}<br>
                <b>ä»·æ ¼å¸¦:</b> ${user.price_range}<br>

                <hr>
                <b>æœç´¢å†å²:</b>
                <ul>${user.search_history.map(x => `<li>${x}</li>`).join("")}</ul>

                <b>æµè§ˆå†å²:</b>
                <ul>${user.view_history.map(x => `<li>${x.name} (${x.price})</li>`).join("")}</ul>

                <b>åŠ è´­å†å²:</b>
                <ul>${user.cart_history.map(x => `<li>${x.name} (${x.price})</li>`).join("")}</ul>

                <b>è´­ä¹°å†å²:</b>
                <ul>${user.purchase_history.map(x => `<li>${x.name} (${x.price})</li>`).join("")}</ul>
            </div>
        `;
    })
}


// =====================
// â‘¡ å¼€å§‹æµå¼è¿‡æ»¤
// =====================
function startFiltering() {
    let userId = document.getElementById("userSelect").value;

    document.getElementById("filterStreamArea").innerHTML =
        "<p class='text-info'>æ­£åœ¨è°ƒç”¨æ¨¡å‹è¿›è¡Œè¿‡æ»¤...</p>";

    document.getElementById("recommendArea").innerHTML = "";

    finishedCount = 0;
    updateProgress();

    let source = new EventSource("/filter_stream?user_id=" + userId);

    source.addEventListener("start", (e) => {
        document.getElementById("filterStreamArea").innerHTML = "";
    });

    source.addEventListener("update", (e) => {
        let data = JSON.parse(e.data);
        finishedCount++;
        updateProgress();

        appendFilterResult(data);

        if (data.result === "å¯æ¨è") {
            appendRecommendCard(data);
        }
    });

    source.addEventListener("done", (e) => {
        source.close();
    });
}


// =====================
// â‘¢ è¿›åº¦æ¡
// =====================
function updateProgress() {
    let p = Math.floor((finishedCount / totalProducts) * 100);
    let bar = document.getElementById("progressBar");
    bar.style.width = p + "%";
    bar.textContent = p + "%";
}


// =====================
// â‘£ ä¸­æ è¾“å‡ºè¿‡æ»¤ç»“æœ
// =====================
function appendFilterResult(data) {
    let area = document.getElementById("filterStreamArea");

    let html = `
        <div class="result-card ${data.result === "å¯æ¨è" ? "good" : "bad"}">
            <b>${data.product.name}</b><br>
            ${data.result}<br>
            <small>${data.reason}</small>
        </div>
    `;
    area.innerHTML += html;
}


// =====================
// â‘¤ å³æ ï¼šå¯æ¨èå•†å“å¡ç‰‡
// =====================
function appendRecommendCard(data) {
    let area = document.getElementById("recommendArea");

    let html = `
        <div class="product-card" id="card_${data.product.product_id}">
            <h5>${data.product.name}</h5>
            <p class="text-muted">${data.product.category} | Â¥${data.product.price}</p>
            <button class="btn btn-warning btn-sm"
                onclick="startCopywriting('${data.product.product_id}')">
                âœ¨ ç”Ÿæˆæ¨èè¯æœ¯
            </button>
            <div id="copy_${data.product.product_id}" class="copy-box mt-2" style="display:none;"></div>
        </div>
    `;
    area.innerHTML += html;
}


// =====================
// â‘¥ å•å•†å“æµå¼æ¨èè¯æœ¯
// =====================
function startCopywriting(productId) {
    let userId = document.getElementById("userSelect").value;

    let box = document.getElementById("copy_" + productId);
    box.style.display = "block";
    box.innerHTML = "<span class='loading-dot'>ç”Ÿæˆä¸­...</span>";

    let source = new EventSource(
        `/copywriting_stream?user_id=${userId}&product_id=${productId}`
    );

    source.addEventListener("update", (e) => {
        let data = JSON.parse(e.data);
        box.innerHTML = data.text;
    });

    source.addEventListener("done", () => {
        source.close();
    });
}
</script>


</body>
</html>
